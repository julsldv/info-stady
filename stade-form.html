<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Stade – Backoffice Stady</title>
  <script>(function(){var p=location.pathname;if(p&&p!=='/'&&location.origin!=='file://'){var b=document.createElement('base');b.href=location.origin+p.replace(/\/?[^/]*$/,'')+'/';document.head.appendChild(b);}})();</script>
  <link rel="stylesheet" href="css/style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/10.11.0/firebase-app-compat.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/10.11.0/firebase-auth-compat.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/10.11.0/firebase-firestore-compat.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/10.11.0/firebase-storage-compat.min.js"></script>
  <script src="js/config.firebase.js"></script>
  <script>if (window.FIREBASE_CONFIG && window.FIREBASE_CONFIG.apiKey !== 'YOUR_API_KEY') firebase.initializeApp(window.FIREBASE_CONFIG);</script>
  <script src="js/auth.js"></script>
  <script src="js/db.js"></script>
  <script src="js/app.js"></script>
</head>
<body class="stade-form-page">
  <div class="stade-form-wrap">
    <header class="stade-form-header">
      <a href="stades.html" class="back-link">← Stades</a>
      <h1 id="title">Nouveau stade</h1>
      <p id="error" class="error"></p>
    </header>
    <form id="form" class="stade-form-grid">
      <div class="form-group fg-nom">
        <label>Nom *</label>
        <input type="text" name="nom" required placeholder="Nom du stade">
      </div>
      <div class="form-group fg-capacite">
        <label>Capacité *</label>
        <input type="number" name="capacite" min="0" required placeholder="0">
      </div>
      <div class="form-group fg-ville">
        <label>Ville</label>
        <input type="text" name="ville" placeholder="Ville">
      </div>
      <div class="form-group fg-pays">
        <label>Pays</label>
        <input type="text" name="pays" placeholder="Pays">
      </div>
      <div class="form-group fg-club">
        <label>Club</label>
        <input type="text" name="club" placeholder="Club">
      </div>
      <div class="form-group fg-coords">
        <label>Coordonnées</label>
        <div class="input-row">
          <input type="number" name="latitude" step="any" placeholder="Lat">
          <input type="number" name="longitude" step="any" placeholder="Long">
        </div>
      </div>
      <div class="form-group fg-descriptif">
        <label>Descriptif</label>
        <textarea name="descriptif" rows="2" placeholder="Description courte"></textarea>
      </div>
      <div class="form-group fg-images">
        <label>Images</label>
        <div class="image-upload">
          <input type="file" id="imageFiles" name="imageFiles" accept="image/*" multiple style="display: none;">
          <button type="button" id="browseImages" class="btn btn-secondary">Parcourir…</button>
          <span id="imageFilesLabel" class="file-label">Aucun fichier</span>
        </div>
        <textarea name="images" rows="2" placeholder="URLs (une par ligne)" class="urls-input"></textarea>
      </div>
      <div class="form-group fg-sports">
        <label>Sports</label>
        <div class="sport-chks">
          <label><input type="checkbox" name="sport" value="football"> Football</label>
          <label><input type="checkbox" name="sport" value="rugby"> Rugby</label>
          <label><input type="checkbox" name="sport" value="tennis"> Tennis</label>
          <label><input type="checkbox" name="sport" value="basket"> Basket</label>
        </div>
      </div>
      <div class="form-group fg-options">
        <label class="checkbox-label"><input type="checkbox" name="isSystem"> isSystem (catalogue)</label>
      </div>
      <div class="form-actions fg-actions">
        <button type="submit" class="btn btn-primary">Enregistrer</button>
        <a href="stades.html" class="btn btn-secondary">Annuler</a>
      </div>
    </form>
  </div>
  <script>
    const params = new URLSearchParams(location.search);
    const id = params.get('id');
    const form = document.getElementById('form');
    const title = document.getElementById('title');
    const errEl = document.getElementById('error');

    (async function init() {
      try {
        await requireAuth();
        if (id) {
          title.textContent = 'Modifier le stade';
          const s = await dbStades.get(id);
          form.nom.value = s.nom || '';
          form.capacite.value = s.capacite ?? '';
          form.descriptif.value = s.descriptif || '';
          form.images.value = (s.images && s.images.length) ? s.images.join('\n') : '';
          form.latitude.value = s.latitude ?? '';
          form.longitude.value = s.longitude ?? '';
          form.ville.value = s.ville || '';
          form.pays.value = s.pays || '';
          form.club.value = s.club || '';
          form.isSystem.checked = s.isSystem === true;
          (s.sports || []).forEach(sport => {
            const cb = form.querySelector('input[name="sport"][value="' + sport + '"]');
            if (cb) cb.checked = true;
          });
        }
      } catch (err) {
        if (err.message !== 'Non authentifié') errEl.textContent = err.message;
      }
    })();

    document.getElementById('browseImages').addEventListener('click', function() {
      document.getElementById('imageFiles').click();
    });
    document.getElementById('imageFiles').addEventListener('change', function() {
      var label = document.getElementById('imageFilesLabel');
      var files = this.files;
      if (files.length === 0) label.textContent = 'Aucun fichier choisi';
      else if (files.length === 1) label.textContent = files[0].name;
      else label.textContent = files.length + ' fichier(s) sélectionné(s)';
    });

    async function uploadStadeImages(stadeId, files) {
      if (!files || !files.length) return [];
      var storage = firebase.storage();
      var refRoot = storage.ref().child('Stades').child(stadeId);
      var urls = [];
      for (var i = 0; i < files.length; i++) {
        var file = files[i];
        var ext = (file.name && file.name.indexOf('.') > -1) ? file.name.substring(file.name.lastIndexOf('.')) : '.jpg';
        var path = 'image_' + i + ext;
        var ref = refRoot.child(path);
        await ref.put(file);
        var url = await ref.getDownloadURL();
        urls.push(url);
      }
      return urls;
    }

    form.addEventListener('submit', async e => {
      e.preventDefault();
      errEl.textContent = '';
      var imagesText = form.images.value.trim();
      var imagesFromUrls = imagesText ? imagesText.split(/[\n,]/).map(function(s) { return s.trim(); }).filter(Boolean) : [];
      var sports = Array.from(form.querySelectorAll('input[name="sport"]:checked')).map(function(c) { return c.value; });
      var imageFiles = document.getElementById('imageFiles').files;
      var hasFiles = imageFiles && imageFiles.length > 0;

      var payload = {
        nom: form.nom.value.trim(),
        capacite: Number(form.capacite.value) || 0,
        descriptif: form.descriptif.value.trim(),
        images: imagesFromUrls.length ? imagesFromUrls : null,
        latitude: form.latitude.value.trim() ? Number(form.latitude.value) : null,
        longitude: form.longitude.value.trim() ? Number(form.longitude.value) : null,
        ville: form.ville.value.trim() || null,
        pays: form.pays.value.trim() || null,
        club: form.club.value.trim() || null,
        isSystem: form.isSystem.checked,
        sports: sports.length ? sports : null,
      };

      try {
        await requireAuth();
        var stadeId = id;
        if (id) {
          if (hasFiles) {
            errEl.textContent = 'Upload des images…';
            var uploadUrls = await uploadStadeImages(id, imageFiles);
            payload.images = (payload.images || []).concat(uploadUrls);
          }
          await dbStades.set(id, payload);
          alert('Stade mis à jour.');
        } else {
          var result = await dbStades.add(payload);
          stadeId = result.id;
          if (hasFiles) {
            errEl.textContent = 'Upload des images…';
            var newUrls = await uploadStadeImages(stadeId, imageFiles);
            payload.images = (payload.images || []).concat(newUrls);
            await dbStades.set(stadeId, payload);
          }
          alert('Stade créé.');
        }
        location.href = 'stades.html';
      } catch (err) {
        errEl.textContent = err.message;
      }
    });
  </script>
</body>
</html>
