<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Contestants – Backoffice Stady</title>
  <script>(function(){var p=location.pathname;if(location.origin!=='file://'&&p.split('/').filter(Boolean).length>1){var b=document.createElement('base');b.href=location.origin+p.replace(/\/?[^/]*$/,'')+'/';document.head.appendChild(b);}})();</script>
  <link rel="stylesheet" href="css/style.css">
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.min.js"></script>
  <script src="js/config.firebase.js"></script>
  <script>if (window.FIREBASE_CONFIG && window.FIREBASE_CONFIG.apiKey !== 'YOUR_API_KEY') firebase.initializeApp(window.FIREBASE_CONFIG);</script>
  <script src="js/auth.js"></script>
  <script src="js/db.js"></script>
  <script src="js/app.js"></script>
</head>
<body>
  <div class="container">
    <p><a href="index.html">← Accueil</a></p>
    <h1>Contestants</h1>
    <div class="filter">
      <label>Sport : </label>
      <select id="filterSport">
        <option value="">Tous</option>
        <option value="football">Football</option>
        <option value="rugby">Rugby</option>
        <option value="tennis">Tennis</option>
        <option value="basket">Basket</option>
      </select>
    </div>
    <p><a href="contestant-form.html" class="btn btn-primary">Nouveau contestant</a></p>
    <p id="error" class="error"></p>
    <p id="loading" class="loading">Chargement…</p>
    <table id="table" style="display:none;">
      <thead>
        <tr>
          <th>Nom</th>
          <th>Sport</th>
          <th></th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <script>
    let allList = [];
    const tbody = document.querySelector('#table tbody');
    const loading = document.getElementById('loading');
    const errEl = document.getElementById('error');
    const table = document.getElementById('table');
    const filterSport = document.getElementById('filterSport');

    function render(list) {
      if (list.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3">Aucun contestant.</td></tr>';
      } else {
        tbody.innerHTML = list.map(c => `
          <tr>
            <td>${escapeHtml(c.Name || '')}</td>
            <td>${escapeHtml(c.Sport || '')}</td>
            <td>
              <a href="contestant-form.html?id=${c.id}" class="edit">Modifier</a>
              <a href="#" class="delete" data-id="${c.id}" data-nom="${escapeHtml(c.Name || '')}">Supprimer</a>
            </td>
          </tr>
        `).join('');
        tbody.querySelectorAll('a.delete').forEach(a => {
          a.addEventListener('click', async e => {
            e.preventDefault();
            if (!confirm('Supprimer « ' + a.dataset.nom + ' » ?')) return;
            try {
              await dbContestants.delete(a.dataset.id);
              a.closest('tr').remove();
            } catch (err) {
              errEl.textContent = err.message;
            }
          });
        });
      }
      table.style.display = 'table';
    }

    async function load() {
      loading.style.display = 'block';
      errEl.textContent = '';
      try {
        await requireAuth();
        const sport = filterSport.value || '';
        allList = await dbContestants.list(sport || undefined);
        loading.style.display = 'none';
        render(allList);
      } catch (err) {
        loading.style.display = 'none';
        if (err.message !== 'Non authentifié') errEl.textContent = err.message;
      }
    }

    filterSport.addEventListener('change', load);
    load();
  </script>
</body>
</html>
